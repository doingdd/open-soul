name: "Soul Evolution Cycle"
description: "The nightly ritual where the agent reflects on daily logs and rewrites its own soul configuration. Includes safety validation."

# â° è§¦å‘å™¨ï¼šæ¯å¤©å‡Œæ™¨ 03:00 æ‰§è¡Œ
trigger:
  type: cron
  schedule: "0 3 * * *"

steps:
  # === 1. å¯åŠ¨æ—¥å¿— ===
  - id: log_start
    uses: log:info
    with:
      message: "ğŸŒŒ Soul Evolution Cycle Started..."

  # === 2. å®‰å…¨å¤‡ä»½ (Safety First) ===
  # åœ¨ä»»ä½•ä¿®æ”¹å‘ç”Ÿå‰ï¼Œå…ˆåˆ›å»ºå¿«ç…§ã€‚
  # å¦‚æœè¿›åŒ–å¤±è´¥ï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨å›æ»šåˆ°è¿™ä¸ªæ–‡ä»¶ã€‚
  - id: backup_soul
    uses: fs:copy
    with:
      source: "./soul/active_soul.yaml"
      destination: "./soul/backup/soul_{{ time.now.unix }}.yaml"

  # === 3. è¯»å–ä¸Šä¸‹æ–‡ (Gather Context) ===
  - id: read_logs
    uses: fs:read
    with:
      path: "./memory/daily_logs.md"

  - id: read_current_soul
    uses: fs:read
    with:
      path: "./soul/active_soul.yaml"

  # === 4. çµé­‚åæ€ (The Dreaming) ===
  # è°ƒç”¨ LLM ç”Ÿæˆæ–°çš„ YAML å­—ç¬¦ä¸²ã€‚
  # ä½¿ç”¨ temperature: 0.1 æä½æ¸©ï¼Œç¡®ä¿æ ¼å¼ç¨³å®šã€‚
  - id: reflect
    uses: llm:generate
    with:
      model: "gpt-4-turbo"
      temperature: 0.1
      prompt: "{{ fs.read('./workflows/reflection.md') }}"
      variables:
        history: "{{ steps.read_logs.content }}"
        soul: "{{ steps.read_current_soul.content }}"

  # === 5. [å…³é”®] æ ¼å¼éªŒè¯ (Validation Gate) ===
  # è¿™æ˜¯ä¸€ä¸ªâ€œé‡‘ä¸é›€â€æµ‹è¯•ã€‚
  # æˆ‘ä»¬å°è¯•ç”¨ Python è§£æç”Ÿæˆçš„ YAMLã€‚å¦‚æœè§£æå¤±è´¥ï¼ˆè¿”å›é0ï¼‰ï¼Œ
  # æ•´ä¸ª Workflow ä¼šåœ¨è¿™é‡ŒæŠ¥é”™åœæ­¢ï¼Œä¸ä¼šæ‰§è¡Œåé¢çš„å†™å…¥æ­¥éª¤ã€‚
  # è¿™æ ·å°±ä¿æŠ¤äº† active_soul.yaml ä¸è¢«è„æ•°æ®è¦†ç›–ã€‚
  - id: validate_yaml
    uses: shell:exec
    with:
      command: |
        cat <<EOF > temp_soul_check.yaml
        {{ steps.reflect.output }}
        EOF
        python3 -c "import yaml; yaml.safe_load(open('temp_soul_check.yaml'))"

  # === 6. å†™å…¥æ–°çµé­‚ (Mutation) ===
  # åªæœ‰å½“ step 5 æˆåŠŸé€šè¿‡åï¼Œæ‰ä¼šæ‰§è¡Œè¿™ä¸€æ­¥ã€‚
  - id: update_soul
    uses: fs:write
    with:
      path: "./soul/active_soul.yaml"
      content: "{{ steps.reflect.output }}"

  # === 7. æ¸…ç†ä¸é‡ç½® (Cleanup) ===
  # æ¸…ç©ºæ¯æ—¥æ—¥å¿—ï¼Œå‡†å¤‡è¿æ¥æ–°çš„ä¸€å¤©ã€‚
  - id: clear_daily_logs
    uses: fs:write
    with:
      path: "./memory/daily_logs.md"
      content: ""

  # åˆ é™¤ä¸´æ—¶éªŒè¯æ–‡ä»¶
  - id: cleanup_temp
    uses: shell:exec
    with:
      command: "rm temp_soul_check.yaml"

  - id: log_success
    uses: log:info
    with:
      message: "âœ… Evolution Complete. The Soul has mutated successfully."