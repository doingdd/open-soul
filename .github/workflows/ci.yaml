name: OSP CI

on:
  push:
    branches: [ "main", "dev" ]
    paths:
      - 'seeds/**'
      - 'osp/**'
      - 'tests/**'
      - 'pyproject.toml'
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.11", "3.12"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install package
      run: pip install -e ".[dev]"

    - name: Validate all seeds
      run: |
        for seed in seeds/*.yaml; do
          osp validate "$seed"
        done

    - name: Run tests with coverage
      run: pytest tests/ --cov=osp --cov-report=term-missing --cov-fail-under=80 -v

    - name: End-to-end smoke test
      run: |
        for seed in tabula_rasa glitch sentinel 10x_engineer; do
          osp init --seed $seed --workspace /tmp/test_$seed
          ls /tmp/test_$seed/SOUL.md /tmp/test_$seed/IDENTITY.md /tmp/test_$seed/AGENTS.md
        done
